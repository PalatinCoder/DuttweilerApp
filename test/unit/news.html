<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>news</title>

    <script>
      // Redux assumes `process.env.NODE_ENV` exists in the ES module build.
      // https://github.com/reactjs/redux/issues/2907
      window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <script src="../../node_modules/@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
    <script src="../../node_modules/chai/chai.js"></script>
    <script src="../../node_modules/mocha/mocha.js"></script>
    <script src="../../node_modules/wct-mocha/wct-mocha.js"></script>
  </head>
  <body>
    <test-fixture id="news">
      <template>
        <news-view active></news-view>
      </template>
    </test-fixture>

    <script type="module">
      import '@polymer/test-fixture';
      import 'axe-core/axe.min.js';
      import {axeReport} from 'pwa-helpers/axe-report.js';

      import '../../src/components/news-view.js';
      import { news_items } from '../../mock-api/data/news.js';

      import { store } from '../../src/store.js';
      import { REQUEST_DATA, RECEIVE_DATA, INVALIDATE_DATA } from '../../src/actions/api-data.js';

      suite('news list', function() {
        var view;

        setup(() => {
          view = fixture('news');
          store.dispatch({type: RECEIVE_DATA, endpoint: 'news', data: news_items, receivedAt: Date.now()});
        });

        test('list is complete', done => {
          flush(() => {
            let cards = view.shadowRoot.querySelectorAll('paper-card');
            assert.lengthOf(cards, news_items.length, 'the number of cards does not equal the number of news items');
            done();
          });
        });
      });

      suite('empty news list', () => {
        test('it show an error');
      });

      suite('news item', function() {
        var view;
        var data = news_items.slice(0,1);

        setup(() => {
          store.dispatch({type: RECEIVE_DATA, endpoint: 'news', data: data, receivedAt: Date.now()});
          view = fixture('news');
        });

        test('heading is correct', done => {
          flush(() => {
            let card = view.shadowRoot.querySelector('paper-card');
            assert.equal(card.heading, data[0].headline);
            done();
          });
        });
        test('date is correct', done => {
          flush(() => {
            let card = view.shadowRoot.querySelector('paper-card');
            let date = card.querySelector('.card-content span').innerText;
            assert.equal(date,data[0].date);
            done();
          });
        });
        test('subheading is correct', done => {
          flush(() => {
            let card = view.shadowRoot.querySelector('paper-card');
            let subheading = card.querySelector('.card-content h3').innerText;
            assert.equal(subheading, data[0].subheadline);
            done();
          });
        });
        test('image is undefined', done => {
          flush(() => {
            let card = view.shadowRoot.querySelector('paper-card');
            assert.isEmpty(card.image, 'image is not undefined');
            // This produces some weird error
            //assert.isUndefined(card.alt, 'alt text is not empty');
            done();
          });
        });
        test('text is correct', done => {
          flush(() => {
            let card = view.shadowRoot.querySelector('paper-card');
            let text = card.querySelector('.card-content p').innerText;
            assert.equal(text, data[0].text);
            done();
          });
        });
        test('read more button');
      });

      suite('news item with an image', () => {
        var view;
        var data = news_items.slice(5,6);

        setup(() => {
          store.dispatch({type: RECEIVE_DATA, endpoint: 'news', data: data, receivedAt: Date.now()});
          view = fixture('news');
        });

        test('image is correct', done => {
          flush(() => {
            let card = view.shadowRoot.querySelector('paper-card');
            assert.equal(card.image, data[0].imageUrl);
            done();
          })
        });
        test('alt text is there', done => {
          flush(() => {
            let card = view.shadowRoot.querySelector('paper-card');
            assert.exists(card.alt);
            done();
          });
        });
      });
    </script>
  </body>
</html>
